# PR-004 — HTTP Adapter (Candle API)

## Purpose

Introduce the **HTTP adapter** that implements the `CandleApi` port defined in `frontend/PR-002.md` and connects the frontend application layer to the backend `/api/v1/candles` endpoint frozen in `docs/PR-011.md`.

This PR is the **only place** where HTTP, JSON transport, and network concerns are allowed.

---

## References

* `AGENTS.md` — global collaboration rules
* `COMMON.md` — shared API semantics
* `frontend/PR-002.md` — CandleApi port & DTOs
* `frontend/PR-003.md` — GetCandleSeries frontend use case
* `docs/PR-011.md` — frozen backend API contract

---

## Scope (Hard Lock)

### ✅ Included

* HTTP implementation of `CandleApi`
* Query parameter mapping
* JSON decoding into DTOs
* Network error translation
* Adapter-level tests

### ❌ Excluded

* UI widgets
* State management
* Caching
* Retry logic
* Authentication

If it is not HTTP transport, it does not belong here.

---

## Folder Structure

```
/frontend/lib/
  features/candles/
    infrastructure/
      http_candle_api.dart

/frontend/test/
  features/candles/infrastructure/
```

---

## HTTP Client Choice (Locked)

* Use `package:http` (dart `http` client)
* No Dio

Rationale:

* Small surface area
* Easy to fake in tests
* No interceptors or magic

---

## Adapter Responsibilities

### HttpCandleApi

Responsibilities:

* Build GET request for `/api/v1/candles`
* Encode query parameters
* Decode JSON response
* Return `CandleSeriesResponse`

Constraints:

* Stateless
* No caching
* No retries
* No Flutter widget dependencies

---

## Request Mapping Rules

* `symbol`, `timeframe`, `from`, `to` mapped 1:1 to query parameters
* `from` and `to` serialized as RFC3339 strings
* Query parameters must be URL-encoded

---

## Response Handling Rules

* HTTP 200 → parse response body
* HTTP 400 → throw client error
* HTTP 500 → throw server error
* Unexpected status → generic failure

Error types may be simple and internal.

---

## Testing Requirements

### Required Test Cases

* `HttpCandleApi_buildsCorrectRequest`
* `HttpCandleApi_parsesSuccessfulResponse`
* `HttpCandleApi_handles400`
* `HttpCandleApi_handles500`

Tests must:

* Fake HTTP client
* Avoid real network calls

---

## Implementation Constraints

* Constructor injection of HTTP client and base URL
* No static globals
* No logging

---

## Definition of Done (PR-004)

PR-004 is considered **done** only when **all** conditions below are met:

* [ ] `CandleApi` implemented via HTTP
* [ ] Query parameters match backend contract
* [ ] JSON decoded into DTOs
* [ ] Error cases covered by tests
* [ ] No UI or state logic present
* [ ] Static analysis passes
* [ ] PR is reviewable in under 20 minutes

---

## Explicit Non-Goals

* No request retries
* No timeout tuning
* No cancellation support

---

## Reviewer Checklist

Reviewer must confirm:

* Adapter respects API contract exactly
* No logic leakage beyond transport
* HTTP client is properly injected

---

## Guiding Principle

Transport is a detail, not a decision.
