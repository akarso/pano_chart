# PR-013 — Overview API Integration

## Goal

Connect the frontend Overview feature to the real backend endpoint:

```
GET /api/overview
```

After this PR:

* Overview screen renders real ranked symbols
* Sparkline data comes from backend
* Total score comes from backend
* No more raw candle fetching inside Overview

This is the first true end‑to‑end integration.

---

# Scope

This PR includes:

* OverviewApi port
* HttpOverviewApi adapter
* DTOs + mapping
* GetOverview concrete implementation
* CompositionRoot wiring
* Bootstrap wiring (Overview becomes app home)

This PR does NOT include:

* Infinite scroll
* Sort dropdown UI
* Rankings screen
* Error UI polish

---

# 1️⃣ Overview API Contract (Backend)

Endpoint:

```
GET /api/overview?timeframe=1h&limit=30
```

Response:

```json
{
  "timeframe": "1h",
  "count": 10,
  "precision": 30,
  "results": [
    {
      "symbol": "BTCUSDT",
      "totalScore": 2.75,
      "sparkline": [42000.0, 42100.0, 41900.0]
    }
  ]
}
```

---

# 2️⃣ New Files

## lib/features/overview/overview_api.dart

```dart
abstract class OverviewApi {
  Future<OverviewResponseDto> fetchOverview({
    required String timeframe,
    required int limit,
  });
}
```

---

## lib/features/overview/dto/overview_response_dto.dart

```dart
class OverviewResponseDto {
  final String timeframe;
  final int count;
  final int precision;
  final List<OverviewItemDto> results;

  OverviewResponseDto({
    required this.timeframe,
    required this.count,
    required this.precision,
    required this.results,
  });

  factory OverviewResponseDto.fromJson(Map<String, dynamic> json) {
    return OverviewResponseDto(
      timeframe: json['timeframe'],
      count: json['count'],
      precision: json['precision'],
      results: (json['results'] as List)
          .map((e) => OverviewItemDto.fromJson(e))
          .toList(),
    );
  }
}

class OverviewItemDto {
  final String symbol;
  final double totalScore;
  final List<double> sparkline;

  OverviewItemDto({
    required this.symbol,
    required this.totalScore,
    required this.sparkline,
  });

  factory OverviewItemDto.fromJson(Map<String, dynamic> json) {
    return OverviewItemDto(
      symbol: json['symbol'],
      totalScore: (json['totalScore'] as num).toDouble(),
      sparkline: (json['sparkline'] as List)
          .map((e) => (e as num).toDouble())
          .toList(),
    );
  }
}
```

---

## lib/features/overview/http_overview_api.dart

```dart
class HttpOverviewApi implements OverviewApi {
  final http.Client client;
  final String baseUrl;

  HttpOverviewApi({
    required this.client,
    required this.baseUrl,
  });

  @override
  Future<OverviewResponseDto> fetchOverview({
    required String timeframe,
    required int limit,
  }) async {
    final uri = Uri.parse(
      '$baseUrl/api/overview?timeframe=$timeframe&limit=$limit',
    );

    final response = await client.get(uri);

    if (response.statusCode != 200) {
      throw Exception('Overview API error: ${response.statusCode}');
    }

    final jsonMap = jsonDecode(response.body);
    return OverviewResponseDto.fromJson(jsonMap);
  }
}
```

---

# 3️⃣ GetOverview Implementation

Replace abstract-only use case with concrete implementation:

```dart
class GetOverviewImpl implements GetOverview {
  final OverviewApi api;

  GetOverviewImpl(this.api);

  @override
  Future<OverviewResult> call({
    required String timeframe,
    required int page,
    required String sort,
    String? snapshot,
  }) async {
    // For now ignore page/sort/snapshot.
    // MVP uses limit-based fetch only.

    final dto = await api.fetchOverview(
      timeframe: timeframe,
      limit: 30,
    );

    return OverviewResult(
      items: dto.results
          .map((e) => OverviewItem(
                symbol: e.symbol,
                totalScore: e.totalScore,
                sparkline: e.sparkline,
              ))
          .toList(),
      hasMore: false,
      snapshot: null,
    );
  }
}
```

Important:

We intentionally ignore pagination for now.
PR‑014 will introduce proper paginated `/api/rankings` integration.

---

# 4️⃣ CompositionRoot Wiring

Inside DI layer:

```dart
final overviewApi = HttpOverviewApi(
  client: httpClient,
  baseUrl: config.apiBaseUrl,
);

final getOverview = GetOverviewImpl(overviewApi);

final overviewViewModel = OverviewViewModel(getOverview);
```

---

# 5️⃣ Bootstrap Fix (Critical)

App must render Overview as home.

Replace placeholder route with:

```dart
home: OverviewWidget(viewModel: overviewViewModel),
```

No more dead placeholder.

---

# 6️⃣ Remove Old Logic

Delete:

* Candle fetching inside Overview
* Any fake OverviewViewModel stub logic

Overview must now render from:

```
vm.state.items
```

---

# Acceptance Criteria

* App launches directly into Overview screen
* Overview renders real backend sparkline data
* Score badge shows real totalScore
* No raw candle fetches for overview
* All tests pass

---

# Result After PR-013

You now have:

* Real backend integration
* Real ranked data on device
* Proper state boundary
* Clean architecture preserved

This is the moment the product becomes tangible.

---

# Next PR

PR‑014 — Infinite Scroll + Rankings Endpoint Integration

We will then:

* Switch to `/api/rankings`
* Implement pagination
* Add sort control
* Introduce snapshot handling

But not before this works end‑to‑end.
