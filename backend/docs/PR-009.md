# PR-009 — Infrastructure Decorator: RedisCandleRepository

## Purpose

Introduce a **Redis-backed caching decorator** for `CandleRepositoryPort`.

This adapter wraps an existing `CandleRepositoryPort` implementation and caches `GetSeries` results to reduce external API calls and control costs.

The decorator must be **transparent** to callers and preserve all port semantics.

---

## References

* `AGENTS.md` — global collaboration rules
* `BACKEND.md` — backend architecture & PR sequencing
* `COMMON.md` — shared caching semantics
* `docs/PR-005.md` — CandleRepositoryPort
* `docs/PR-008.md` — FreeTierMarketDataProvider

All definitions in this PR must be consistent with the above.

---

## Scope (Hard Lock)

### ✅ Included

* Redis-backed decorator implementing CandleRepositoryPort
* Cache key strategy
* Decorator unit tests

### ❌ Excluded

* Redis connection pooling configuration
* Cache eviction strategies beyond TTL
* Metrics or logging
* Write-through or write-behind caching

If it is not **read-through caching**, it does not belong here.

---

## Allowed Files

```
/backend/adapters/infra/redis_candlerepository.go
/backend/tests/adapters/infra/redis_candlerepository_test.go
```

No other files may be modified.

---

## Decorator Responsibilities

### Read-Through Behavior

* On `GetSeries` call:

  1. Compute cache key
  2. Attempt to load cached value
  3. On hit → return cached CandleSeries
  4. On miss → delegate to wrapped repository
  5. Store result in Redis with TTL

---

### Cache Key Strategy

Cache key must uniquely identify a request by:

* Symbol
* Timeframe
* From timestamp (UTC, RFC3339)
* To timestamp (UTC, RFC3339)

Key format is implementation-defined but must be deterministic.

---

### TTL Rules

* TTL is fixed per instance (constructor argument)
* TTL must be > 0

---

### Serialization Rules

* Cached data must represent full CandleSeries
* Serialization format is implementation-defined
* Deserialization must reconstruct identical domain objects

---

## Error Handling

* Redis failures must **not** prevent repository access

* On Redis error:

  * Log or ignore internally
  * Fallback to wrapped repository

* Wrapped repository errors are propagated

---

## Behavioral Specification (Tests Must Cover All)

### Required Test Cases (Minimum)

* `TestRedisCandleRepository_ReturnsCachedResultOnHit`
* `TestRedisCandleRepository_DelegatesOnCacheMiss`
* `TestRedisCandleRepository_CachesResultAfterMiss`
* `TestRedisCandleRepository_IgnoresRedisErrors`
* `TestRedisCandleRepository_PropagatesRepositoryError`

Tests must use a **fake Redis client** and a **fake wrapped repository**.

---

## Implementation Constraints

* Decorator implements CandleRepositoryPort
* Redis client injected via constructor
* No global Redis clients
* No hard dependency on specific Redis library (use minimal interface)

---

## Definition of Done (PR-009)

PR-009 is considered **done** only when **all** conditions below are met:

* [ ] Redis decorator implements CandleRepositoryPort
* [ ] Cache hit and miss paths are tested
* [ ] Redis failures do not break functionality
* [ ] TTL behavior is configurable
* [ ] No files outside allowed list are changed
* [ ] No direct dependency on concrete Redis client
* [ ] Static analysis passes with no new warnings
* [ ] CI pipeline is green
* [ ] PR is reviewable in under 20 minutes

---

## Explicit Non-Goals

* No cache invalidation beyond TTL
* No partial caching
* No write operations

---

## Reviewer Checklist

Reviewer must confirm:

* Cache decorator is transparent
* Wrapped repository is always fallback
* Domain invariants are preserved

---

## Guiding Principle

Caching is an optimization, not a dependency.
