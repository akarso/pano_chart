# PR-012.1 — Tighten Sideways Heuristic Math

## Goal

Refine and formalize the **sideways / range-bound scoring heuristic** introduced in PR-012, making the math:

* explicit
* deterministic
* testable
* resistant to false positives (flat lines or slow trends)

No new concepts are introduced; this PR strictly tightens definitions.

---

## Scope

**Included**

* Formal mathematical definition of sideways score components
* Explicit normalization rules
* Clear acceptance thresholds encoded via tests

**Explicitly Excluded**

* New scoring categories
* Weight tuning or ranking logic
* Any application / infra / UI changes

---

## Design Intent (Plain Language)

A symbol is considered **sideways** when:

1. It does **not go anywhere overall**
2. It stays within a **stable price band**
3. It **moves back and forth frequently** inside that band

All three must be true.

---

## Definitions

Let:

* `prices[]` = close prices from CandleSeries
* `n` = number of candles
* `p0` = first close
* `pn` = last close
* `mean` = arithmetic mean of prices

---

## Component Metrics

### 1. Net Displacement Ratio (NDR)

Measures whether price actually went somewhere.

```
ndr = |pn - p0| / (max(prices) - min(prices))
```

Properties:

* Range: 0 → ∞
* Near 0 → good sideways candidate
* Penalizes slow drift and breakouts

If range is zero → score = 0 (flat line)

---

### 2. Range Stability Score (RSS)

Measures whether the price envelope is stable.

Steps:

1. Compute rolling window highs and lows
2. For each window:

```
range_i = high_i - low_i
```

3. Compute coefficient of variation:

```
rss = 1 - (stddev(range_i) / mean(range_i))
```

Properties:

* Normalized to (-∞, 1]
* Values near 1 → stable range
* Negative values → unstable / expanding range

---

### 3. Oscillation Density Score (ODS)

Measures zig-zag behavior.

Steps:

1. Count local extrema:

   * price[i] > price[i-1] && price[i] > price[i+1]
   * price[i] < price[i-1] && price[i] < price[i+1]

2. Normalize:

```
ods = extrema_count / (n - 2)
```

Properties:

* Range: 0 → 1
* Flat line → 0
* Clean oscillation → higher values

---

## Final Sideways Score

```
sideways_score = (1 - ndr) * rss * ods
```

Clamping rules:

* Each component is clamped to [0, 1]
* Final score is clamped to [0, 1]

---

## Expected Behavior

| Pattern                | Expected Score |
| ---------------------- | -------------- |
| Flat line              | ~0             |
| Clean zig-zag, bounded | High           |
| Slow drift             | Low            |
| Breakout trend         | ~0             |
| Noisy volatility       | Low            |

---

## Test Strategy

Tests define numeric expectations.

### Required Tests

* Perfect oscillation in fixed band → score > 0.7
* Flat price → score == 0
* Linear trend → score < 0.2
* Expanding volatility → score < stable case

### Data Rules

* Hand-crafted price arrays
* No randomness
* Explicit assertions with tolerances

---

## Acceptance Criteria

PR-012.1 is complete when:

* Sideways math is fully specified
* All components are independently test-covered
* No other heuristics are modified
* PR-012 tests remain valid or are tightened

---

## Non-Goals

* Market regime prediction
* Adaptive window sizing
* Statistical significance testing

This PR makes the sideways score **trustworthy, not fancy**.
