PR-017 — CoinGecko Data Provider Implementation
Goal

Implement a concrete CoinGecko-backed CandleRepositoryPort that fetches OHLC data for symbols, mapping it into the domain CandleSeries. Fully compatible with the RankSymbols use case and the SymbolUniversePort from PR-016.

No caching, no business logic, just a clean adapter.

Scope

Included

CoinGecko REST adapter implementing CandleRepositoryPort

HTTP client integration

Mapping from CoinGecko OHLC → domain CandleSeries

Minimal error handling (fail fast)

Deterministic, testable output for integration tests

Excluded

Caching (handled in PR-009)

Authentication / API key rotation

Advanced batching / concurrency

Symbol filtering / universe selection (PR-016 handles this)

Design Principles

Adapter only; domain logic remains untouched

Pure translation of CoinGecko response → domain types

Deterministic output for the same input

Fixed lookback (e.g., 200 candles)

Explicit mapping of supported timeframes (e.g., 15m, 1h, 4h, 1d)

Adapter Responsibilities

Translate domain Symbol → CoinGecko ID

Translate domain Timeframe → CoinGecko interval

Make HTTP request to CoinGecko /coins/{id}/ohlc endpoint

Map JSON response into CandleSeries (ordered by timestamp)

Handle errors: HTTP failures, missing data, malformed response

Example Mapping

CoinGecko JSON:

[
  [1672531200000, 47000.0, 47200.0, 46900.0, 47150.0],
  [1672532100000, 47150.0, 47300.0, 47100.0, 47200.0]
]


Mapped to domain:

CandleSeries{
    Candles: []Candle{
        {Time: 1672531200000, Open: 47000, High: 47200, Low: 46900, Close: 47150},
        {Time: 1672532100000, Open: 47150, High: 47300, Low: 47100, Close: 47200},
    },
}

Timeframe Mapping
Domain	CoinGecko API param
15m	15
1h	60
4h	240
1d	1440

Unsupported timeframes → return error.

HTTP Client Strategy

Standard library net/http (or internal HTTP client wrapper)

Simple GET requests

Timeout: 5–10s

Fail fast on non-200

Test Strategy
Unit Tests

Stub HTTP client to return sample CoinGecko JSON

Assert correct mapping to CandleSeries

Assert unsupported timeframes return errors

Test deterministic ordering

Integration Tests (Optional / PR-017)

Point at sandbox / mock CoinGecko

Validate end-to-end conversion

No real network calls in CI

Acceptance Criteria

PR-017 is complete when:

CoinGeckoCandleRepository implements CandleRepositoryPort

Correct OHLC → CandleSeries mapping exists

Supported timeframes translate correctly

Adapter works with PR-016 SymbolUniversePort to produce data

All unit tests pass

No domain logic is modified

----

Suggested file structure
lib/
  adapters/
    candle_repository/
      coingecko_repository.go
      dto.go
      mapping.go
      errors.go

coingecko_repository.go (stubs)
package candle_repository

import (
    "fmt"
    "net/http"
    "time"

    "yourapp/domain"
)

// CoinGeckoCandleRepository implements domain.CandleRepositoryPort
type CoinGeckoCandleRepository struct {
    httpClient *http.Client
    baseURL    string // e.g., "https://api.coingecko.com/api/v3"
}

// NewCoinGeckoCandleRepository constructs the adapter
func NewCoinGeckoCandleRepository(client *http.Client) *CoinGeckoCandleRepository {
    return &CoinGeckoCandleRepository{
        httpClient: client,
        baseURL:    "https://api.coingecko.com/api/v3",
    }
}

// GetSeries fetches candles for a given symbol & timeframe
func (r *CoinGeckoCandleRepository) GetSeries(symbol domain.Symbol, timeframe domain.Timeframe) (domain.CandleSeries, error) {
    // 1. Translate domain Symbol → CoinGecko ID
    cgID := symbolToCoinGeckoID(symbol)

    // 2. Translate domain Timeframe → CoinGecko interval (minutes)
    interval, err := timeframeToMinutes(timeframe)
    if err != nil {
        return domain.CandleSeries{}, err
    }

    // 3. Build URL
    url := fmt.Sprintf("%s/coins/%s/ohlc?vs_currency=usd&days=1&interval=%d", r.baseURL, cgID, interval)

    // 4. Fetch data (stubbed for now)
    // resp, err := r.httpClient.Get(url)
    // ... handle HTTP errors

    // 5. Map JSON response → domain.CandleSeries
    series := domain.CandleSeries{} // TODO: parse and map

    return series, nil
}

mapping.go (stubs)
package candle_repository

import (
    "yourapp/domain"
)

// mapJSONToCandleSeries maps raw CoinGecko JSON to domain.CandleSeries
func mapJSONToCandleSeries(jsonData []byte) (domain.CandleSeries, error) {
    // TODO: Unmarshal JSON array of arrays [[timestamp, open, high, low, close], ...]
    return domain.CandleSeries{}, nil
}

dto.go (stubs, optional)
package candle_repository

// CoinGeckoOHLC represents a single OHLC point from CoinGecko
type CoinGeckoOHLC struct {
    Timestamp int64
    Open      float64
    High      float64
    Low       float64
    Close     float64
}

errors.go (optional helper)
package candle_repository

import "errors"

var (
    ErrUnsupportedTimeframe = errors.New("unsupported timeframe")
    ErrInvalidSymbol        = errors.New("invalid symbol")
)

Notes / Best Practices

Symbol mapping lives only inside the adapter: symbolToCoinGeckoID(symbol)

Keeps domain symbols agnostic of CoinGecko.

Timeframe translation: timeframeToMinutes()

Only map supported intervals: 15m, 1h, 4h, 1d.

Fail fast on HTTP or JSON errors; caching handled elsewhere (PR-009).

Unit tests stub HTTP client responses, parse JSON, assert deterministic CandleSeries.

Integration tests can point to sandbox or mock endpoints for end-to-end verification.