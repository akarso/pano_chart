# PR-004 — Domain: CandleSeries Collection

## Purpose

Introduce **CandleSeries**, an ordered, immutable collection of Candle value objects.

CandleSeries represents a **time-aligned, gap-aware sequence of candles** for a single Symbol and Timeframe.

This PR defines ordering rules, invariants, and safe read operations using tests as the specification.

---

## References

* `AGENTS.md` — global collaboration rules
* `BACKEND.md` — backend architecture & PR sequencing
* `COMMON.md` — shared domain semantics
* `docs/PR-002.md` — Timeframe
* `docs/PR-003.md` — Candle

This PR assumes **Candle, Timeframe, and Symbol already exist** and are stable.

---

## Scope (Hard Lock)

### ✅ Included

* CandleSeries domain collection
* CandleSeries unit tests

### ❌ Excluded

* Persistence logic
* Pagination or streaming
* Indicator calculations
* Any infrastructure or application logic

If it is not **ordering or validating Candles**, it does not belong here.

---

## Allowed Files

```
/backend/domain/candleseries.go
/backend/tests/domain/candleseries_test.go
```

No other files may be modified.

---

## CandleSeries Definition

A CandleSeries:

* Contains **zero or more** Candle objects
* Is bound to exactly **one Symbol**
* Is bound to exactly **one Timeframe**
* Is ordered by ascending candle timestamp

---

## Behavioral Specification (Tests Must Cover All)

### Creation Rules

* CandleSeries is created via a constructor
* Accepts an empty slice of candles
* All candles must share:

  * the same Symbol
  * the same Timeframe

Mixed Symbol or Timeframe must be rejected.

---

### Ordering Rules

* Candles are always ordered by timestamp (ascending)
* Input order does not matter
* Output order is deterministic

---

### Gap Detection

* CandleSeries can detect gaps between consecutive candles

* A gap exists when:

  * next.timestamp != current.timestamp + timeframe.duration

* Gap detection is read-only

* Gaps do **not** invalidate the series

---

### Uniqueness Rules

* No two candles may share the same timestamp
* Duplicate timestamps must be rejected at construction

---

### Immutability Rules

* CandleSeries is immutable
* No methods may mutate internal state
* Returned slices must be defensive copies

---

### Safe Read Operations

CandleSeries exposes:

* `Len()` → number of candles
* `At(index)` → candle at index or error
* `First()` → earliest candle or error
* `Last()` → latest candle or error
* `All()` → ordered slice copy

All read operations are side-effect free.

---

## Test Requirements

* Tests must be written **before** implementation
* Each test covers one behavior
* Table-driven tests preferred where applicable

### Required Test Cases (Minimum)

* `TestCandleSeries_AllowsEmptySeries`
* `TestCandleSeries_RejectsMixedSymbols`
* `TestCandleSeries_RejectsMixedTimeframes`
* `TestCandleSeries_OrdersCandlesByTimestamp`
* `TestCandleSeries_RejectsDuplicateTimestamps`
* `TestCandleSeries_DetectsGapsCorrectly`
* `TestCandleSeries_IsImmutable`

---

## Implementation Constraints

* CandleSeries is a domain collection, not an entity
* No external dependencies
* Constructor enforces all invariants
* Internals must not be exposed

---

## Definition of Done (PR-004)

PR-004 is considered **done** only when **all** conditions below are met:

* [ ] All required CandleSeries tests are implemented
* [ ] Tests fail before implementation
* [ ] Tests pass after implementation
* [ ] No files outside allowed list are changed
* [ ] Ordering and uniqueness rules are enforced
* [ ] Immutability is guaranteed
* [ ] Gap detection logic is fully tested
* [ ] Static analysis passes with no new warnings
* [ ] CI pipeline is green
* [ ] PR is reviewable in under 15 minutes

---

## Explicit Non-Goals

* No candle aggregation or merging
* No resampling
* No indicator logic

---

## Reviewer Checklist

Reviewer must confirm:

* Ordering logic is deterministic
* Gap detection matches Timeframe duration
* No hidden mutation paths exist

---

## Guiding Principle

A CandleSeries preserves truth, even when data is missing.
