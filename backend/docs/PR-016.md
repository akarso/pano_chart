# PR-016 — Free‑Tier Market Data Adapter & Symbol Universe

## Goal

Introduce a **production-ready but free‑tier–friendly market data adapter** and a concrete **symbol universe provider**, wiring real external data into the backend while respecting API limits.

This PR is where the backend becomes *actually useful* beyond tests and stubs.

---

## Scope

**Included**

* Concrete implementation of `CandleRepositoryPort`
* Concrete implementation of `SymbolUniversePort`
* Free-tier–aware request shaping (limits, batching)
* Deterministic symbol ordering

**Explicitly Excluded**

* Redis caching (already handled by PR-009)
* Authentication / API keys rotation
* Multiple data providers
* WebSockets / streaming

---

## Design Principles

* Prefer correctness and determinism over completeness
* Stay within free-tier API limits by design
* Make provider easily replaceable later
* No business logic outside adapters

---

## Market Data Provider

### Initial Choice

A single free-tier REST provider (examples):

* Binance public REST API
* Coinbase public candles API

(Exact provider selected during implementation; interface remains stable.)

---

## CandleRepositoryPort Implementation

Implements:

```go
GetSeries(symbol Symbol, timeframe Timeframe) (CandleSeries, error)
```

### Adapter Responsibilities

* Translate domain `Symbol` → provider symbol
* Translate domain `Timeframe` → provider interval
* Fetch candles via HTTP
* Map provider response → domain `CandleSeries`

### Lookback Policy (Explicit)

* Fixed candle count per request (e.g. 200)
* Justified as:

  * sufficient for scoring heuristics
  * safe for free-tier limits

No dynamic lookback logic in this PR.

---

## SymbolUniversePort Implementation

Provides:

```go
ListSymbols() ([]Symbol, error)
```

### Initial Policy

* Static or semi-static symbol list
* Deterministic ordering
* Example strategies:

  * Top N symbols by known liquidity (hard-coded)
  * All symbols ending in `USDT` from provider metadata

Filtering and enrichment are deferred.

---

## Rate Limit Strategy

* Sequential fetching by default
* Optional small concurrency cap (e.g. 3–5)
* All HTTP calls routed through adapter

Redis decorator (PR-009) expected to eliminate most repeat calls.

---

## Error Handling

* Provider HTTP errors → propagated as infra errors
* Partial failures → fail fast (no silent skips)
* Malformed provider data → error

No retries in this PR.

---

## Test Strategy

### Unit Tests

* Provider response → CandleSeries mapping
* Timeframe translation correctness

### Integration Tests

* HTTP client stubbed
* No live API calls

---

## Acceptance Criteria

PR-016 is complete when:

* Real candle data can be fetched for real symbols
* Symbol universe is non-empty and deterministic
* Works end-to-end with:

  * PR-013 (ranking)
  * PR-014 (HTTP API)
  * PR-009 (Redis cache)

---

## Follow-ups

* **PR-017** — Production wiring & config
* **PR-018** — Multi-provider abstraction

---

## Non-Goals

* Perfect market coverage
* Volume-based filtering
* Indicator precomputation

This PR connects the system to the real market — carefully.
