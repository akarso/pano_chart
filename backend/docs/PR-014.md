# PR-014 — Ranking API (HTTP Adapter)

## Goal

Expose symbol ranking results via a **read-only HTTP API**, backed by the `RankSymbols` application use case.

This PR is the first point where the backend becomes externally consumable, while keeping all business logic in lower layers.

---

## Scope

**Included**

* HTTP adapter for symbol ranking
* Request parsing and validation
* Mapping between HTTP DTOs and domain/application types
* Deterministic JSON response schema

**Explicitly Excluded**

* Authentication / authorization
* Persistence
* Caching (handled in later PRs)
* WebSockets or streaming

---

## Design Principles

* Thin adapter: no business logic
* One endpoint, one responsibility
* Deterministic output for identical input
* Explicit, documented defaults

---

## Endpoint Definition

```
GET /api/rankings
```

### Query Parameters

| Name        | Required | Description                                   |
| ----------- | -------- | --------------------------------------------- |
| `timeframe` | yes      | Timeframe identifier (e.g. `15m`, `1h`)       |
| `limit`     | no       | Max number of symbols to return (default: 30) |

Notes:

* Ranking strategy is fixed for now (default weights)
* Symbol universe is fixed (configured server-side)

---

## Request Flow

1. Parse and validate query params
2. Resolve `Timeframe` domain object
3. Load CandleSeries for all symbols (via existing ports)
4. Invoke `RankSymbols`
5. Map result to HTTP response

---

## Response Schema

```json
{
  "timeframe": "15m",
  "count": 30,
  "results": [
    {
      "symbol": "BTCUSDT",
      "totalScore": 0.82,
      "scores": {
        "gain": 0.12,
        "trend": 0.05,
        "sideways": 0.65
      }
    }
  ]
}
```

Rules:

* Scores are floats, not rounded by server
* Ordering matches ranking order

---

## Error Handling

| Condition           | HTTP |
| ------------------- | ---- |
| Invalid timeframe   | 400  |
| Invalid limit       | 400  |
| Upstream data error | 502  |
| Internal error      | 500  |

Error body:

```json
{ "error": "human-readable message" }
```

---

## Implementation Notes

* Use standard net/http (or existing router)
* No framework-specific magic
* Handler should depend on interfaces only

Suggested file layout:

```
lib/
  adapters/
    http/
      rankings_handler.go
      dto.go
```

---

## Test Strategy

### Unit Tests

* Request validation (timeframe, limit)
* Mapping from application result to JSON

### Integration Tests

* Stub RankSymbols use case
* Deterministic HTTP response

No live API calls.

---

## Acceptance Criteria

PR-014 is complete when:

* `/api/rankings` endpoint exists
* It calls `RankSymbols` exactly once per request
* No domain or application logic leaks into HTTP layer
* Tests cover success and error paths

---

## Follow-ups

* **PR-015** — Redis cache decorator
* **PR-016** — Free-tier market data adapter

---

## Non-Goals

* User-specific rankings
* Real-time updates
* Pagination beyond simple limit

This PR makes the backend **useful without making it complicated**.
