# PR-003 — Domain: Candle Value Object

## Purpose

Introduce the **Candle** value object into the domain layer.

A Candle represents a single OHLCV datapoint for a given timeframe and symbol.

This PR defines the **structure, invariants, and behavior** of Candle using tests as the specification.

---

## References

* `AGENTS.md` — global collaboration rules
* `BACKEND.md` — backend architecture & PR sequencing
* `COMMON.md` — shared domain semantics
* `docs/PR-002.md` — Timeframe value object

This PR assumes **Timeframe already exists** and is stable.

---

## Scope (Hard Lock)

### ✅ Included

* Candle value object (domain)
* Candle unit tests

### ❌ Excluded

* Symbol implementation (assumed existing)
* Collections of candles
* Persistence or transport models
* Any application or infrastructure logic

If it is not **a single Candle**, it does not belong here.

---

## Allowed Files

```
/backend/domain/candle.go
/backend/tests/domain/candle_test.go
```

No other files may be modified.

---

## Candle Definition

A Candle consists of:

* Symbol (value object)
* Timeframe (value object)
* Timestamp (open time, UTC)
* Open price
* High price
* Low price
* Close price
* Volume

All fields are required.

---

## Behavioral Specification (Tests Must Cover All)

### Creation Rules

* Candle must be created via a constructor
* All fields are required
* Timestamp must be in UTC
* Prices and volume must be non-negative

---

### Price Invariants

* `High >= max(Open, Close)`
* `Low <= min(Open, Close)`
* `High >= Low`

Violations must be rejected at construction time.

---

### Temporal Invariants

* Timestamp represents the **opening time** of the candle
* Timestamp must align with the Timeframe

Examples:

* `1m` candle → timestamp second = 0
* `5m` candle → minute divisible by 5
* `1h` candle → minute = 0, second = 0

---

### Immutability Rules

* Candle is immutable after creation
* No setters or mutation methods

---

### Equality Semantics

* Two candles are equal if:

  * Symbol is equal
  * Timeframe is equal
  * Timestamp is equal

Prices and volume are **not** part of identity.

---

### Derived Properties

* Candle exposes:

  * `IsBullish()` → close > open
  * `IsBearish()` → close < open
  * `IsDoji()` → close == open

These are pure, side-effect-free methods.

---

## Test Requirements

* Tests must be written **before** implementation
* Each test validates exactly one rule
* Table-driven tests are preferred

### Required Test Cases (Minimum)

* `TestCandle_CreatesWithValidData`
* `TestCandle_RejectsNegativePrices`
* `TestCandle_RejectsInvalidHighLowInvariant`
* `TestCandle_RejectsNonUTCTimestamp`
* `TestCandle_RejectsMisalignedTimestamp`
* `TestCandle_EqualityBasedOnIdentity`
* `TestCandle_BullBearDojiClassification`

---

## Implementation Constraints

* Candle is a value object
* No external dependencies
* Constructor enforces all invariants
* No floating-point tolerance logic (exact comparison)

---

## Definition of Done (PR-003)

PR-003 is considered **done** only when **all** conditions below are met:

* [ ] All required Candle tests are implemented
* [ ] Tests fail before Candle implementation exists
* [ ] Tests pass after implementation
* [ ] No files outside allowed list are changed
* [ ] Candle is immutable
* [ ] All invariants are enforced at construction
* [ ] Equality semantics are explicit and tested
* [ ] Static analysis passes with no new warnings
* [ ] CI pipeline is green
* [ ] PR is reviewable in under 15 minutes

---

## Explicit Non-Goals

* No candle aggregation
* No indicators (RSI, MA, etc.)
* No time-series logic

---

## Reviewer Checklist

Reviewer must confirm:

* Tests describe Candle behavior clearly
* Invariants are enforced exactly once (constructor)
* No scope creep occurred

---

## Guiding Principle

A Candle is a fact. Facts do not change.
