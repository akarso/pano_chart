# PR-008 — Infrastructure Adapter: FreeTierMarketDataProvider

## Purpose

Introduce the first **infrastructure adapter** that implements `CandleRepositoryPort` using a **free-tier crypto market data API**.

This adapter is responsible for:

* fetching raw candle data from an external service
* translating it into domain objects
* exposing it via the application port

This PR intentionally targets **free-tier limits and constraints**.

---

## References

* `AGENTS.md` — global collaboration rules
* `BACKEND.md` — backend architecture & PR sequencing
* `COMMON.md` — shared domain semantics
* `docs/PR-005.md` — CandleRepositoryPort
* `docs/PR-006.md` — GetCandleSeries use case
* `docs/PR-007.md` — HTTP adapter

All definitions in this PR must be consistent with the above.

---

## Scope (Hard Lock)

### ✅ Included

* Infrastructure adapter implementing CandleRepositoryPort
* HTTP client logic for external API
* Adapter unit tests

### ❌ Excluded

* Redis or any caching layer
* Paid API tiers
* Retry / backoff logic
* Rate limiting middleware
* Authentication secrets handling

If it is not **external API → domain translation**, it does not belong here.

---

## Allowed Files

```
/backend/adapters/infra/freetier_candlerepository.go
/backend/tests/adapters/infra/freetier_candlerepository_test.go
```

No other files may be modified.

---

## External API Assumptions

The adapter must assume a **typical free-tier REST API** with:

* OHLCV endpoint
* Maximum candles per request (e.g. 500–1000)
* No authentication or API key optional

**Concrete provider is not hardcoded in this PR.**

---

## Adapter Responsibilities

### Data Fetching

* Build request using symbol, timeframe, from, to
* Respect free-tier limits (single request only)
* No pagination or looping

---

### Data Translation

* Map external response into domain Candle objects
* Construct CandleSeries from mapped candles
* Enforce domain invariants (via constructors)

---

### Error Handling

* Network errors → return error
* Malformed responses → return error
* Domain construction failures → return error
* Adapter must not panic

---

## Behavioral Specification (Tests Must Cover All)

### Required Test Cases (Minimum)

* `TestFreeTierCandleRepository_ImplementsPort`
* `TestFreeTierCandleRepository_MapsValidResponseToCandleSeries`
* `TestFreeTierCandleRepository_ReturnsErrorOnHTTPFailure`
* `TestFreeTierCandleRepository_ReturnsErrorOnInvalidPayload`

Tests must stub HTTP responses (no real network calls).

---

## Implementation Constraints

* Adapter implements CandleRepositoryPort
* Uses standard library HTTP client
* External API base URL configurable via constructor
* No global configuration

---

## Definition of Done (PR-008)

PR-008 is considered **done** only when **all** conditions below are met:

* [ ] Free-tier adapter implements CandleRepositoryPort
* [ ] All required adapter tests are implemented
* [ ] Tests fail before implementation
* [ ] Tests pass after implementation
* [ ] No real HTTP calls in tests
* [ ] Adapter respects domain invariants
* [ ] No files outside allowed list are changed
* [ ] Static analysis passes with no new warnings
* [ ] CI pipeline is green
* [ ] PR is reviewable in under 20 minutes

---

## Explicit Non-Goals

* No caching
* No retries
* No rate limit handling
* No provider-specific optimizations

---

## Reviewer Checklist

Reviewer must confirm:

* Adapter contains no business logic
* External API assumptions are minimal
* Domain objects are constructed correctly

---

## Guiding Principle

Infrastructure adapts. The domain stays pure.
